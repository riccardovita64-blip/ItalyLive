<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Studio Live Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { background-color: #000; color: white; overflow: hidden; }
        #localVideo { width: 100%; height: 100%; object-fit: cover; }
        .control-panel {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 20px; z-index: 20;
        }
        .status-badge {
            position: absolute; top: 20px; left: 20px; z-index: 20;
            background: rgba(255, 0, 0, 0.8); padding: 5px 15px;
            border-radius: 20px; font-weight: bold; font-size: 14px;
            box-shadow: 0 0 15px rgba(255,0,0,0.5);
        }
    </style>
</head>
<body>

    <div id="live-badge" class="status-badge hidden">ðŸ”´ IN ONDA</div>

    <!-- Video a tutto schermo (come la fotocamera del telefono) -->
    <div class="fixed inset-0 z-0">
        <video id="localVideo" autoplay muted playsinline></video>
        <canvas id="canvas" class="hidden"></canvas>
    </div>

    <!-- Pannello Controlli -->
    <div class="control-panel">
        <a href="/" class="bg-gray-800/80 p-4 rounded-full backdrop-blur-md border border-gray-600 text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </a>

        <button id="btn-start" onclick="startStreaming()" class="bg-green-600 p-6 rounded-full shadow-lg border-4 border-green-400 hover:bg-green-500 transition transform active:scale-95">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
        </button>

        <button id="btn-stop" onclick="stopStreaming()" class="hidden bg-red-600 p-6 rounded-full shadow-lg border-4 border-red-400 hover:bg-red-500 transition transform active:scale-95 animate-pulse">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path></svg>
        </button>
    </div>

    <script>
        const socket = io();
        // Assicurati che {{ stream.id }} sia renderizzato come numero o stringa
        const streamId = "{{ stream.id }}";
        const video = document.getElementById('localVideo');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let streamingInterval = null;

        // Richiedi fotocamera posteriore
        const constraints = {
            audio: false,
            video: { 
                facingMode: 'environment', // Chiede la camera posteriore
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        navigator.mediaDevices.getUserMedia(constraints)
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(err => {
                alert("Errore fotocamera: " + err);
                console.error(err);
            });

        function startStreaming() {
            socket.emit('stream_status_change', { stream_id: streamId, status: 'live' });
            document.getElementById('btn-start').classList.add('hidden');
            document.getElementById('btn-stop').classList.remove('hidden');
            document.getElementById('live-badge').classList.remove('hidden');

            // 10 FPS per non sovraccaricare la rete mobile
            streamingInterval = setInterval(() => {
                canvas.width = 640; // Risoluzione ridotta per velocitÃ 
                canvas.height = 360;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = canvas.toDataURL('image/jpeg', 0.6);
                socket.emit('stream_frame', { stream_id: streamId, image: imageData });
            }, 100);
        }

        function stopStreaming() {
            clearInterval(streamingInterval);
            socket.emit('stream_status_change', { stream_id: streamId, status: 'offline' });
            document.getElementById('btn-start').classList.remove('hidden');
            document.getElementById('btn-stop').classList.add('hidden');
            document.getElementById('live-badge').classList.add('hidden');
        }
    </script>
</body>
</html>
